name: Permanent RDP Service

on:
  workflow_dispatch:
    inputs:
      use_random_password:
        description: 'ä½¿ç”¨éšæœºå¯†ç ï¼ˆè¦†ç›–å…¶ä»–è®¾ç½®ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  RDP_USERNAME: 'RDPUser'

jobs:
  permanent-rdp:
    runs-on: [self-hosted, windows]
    timeout-minutes: 2592000  # 30å¤©åä¹‰å€¼ï¼Œå®é™…æ— é™
    
    steps:
      - name: Check Runner Environment
        run: |
          Write-Host "=== ç¯å¢ƒæ£€æŸ¥ ==="
          Write-Host "è®¡ç®—æœºå: $env:COMPUTERNAME"
          Write-Host "ç³»ç»Ÿç‰ˆæœ¬: $(Get-WmiObject Win32_OperatingSystem).Caption"
          Write-Host "è¿è¡Œç›®å½•: $(Get-Location)"
          Write-Host "================="

      - name: Configure RDP Settings
        run: |
          Write-Host "=== é…ç½® RDP è®¾ç½® ==="
          
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Write-Host "âœ… å·²å¯ç”¨è¿œç¨‹æ¡Œé¢"
          
          # é…ç½® RDP è®¤è¯è®¾ç½®
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
          Write-Host "âœ… å·²é…ç½® RDP è®¤è¯è®¾ç½®"
          
          # é…ç½®é˜²ç«å¢™è§„åˆ™
          netsh advfirewall firewall delete rule name="Permanent-RDP" 2>&1 | Out-Null
          netsh advfirewall firewall add rule name="Permanent-RDP" `
            dir=in action=allow protocol=TCP localport=3389 `
            description="GitHub Actions Permanent RDP Service"
          Write-Host "âœ… å·²é…ç½®é˜²ç«å¢™è§„åˆ™"
          
          # é‡å¯è¿œç¨‹æ¡Œé¢æœåŠ¡
          Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          Write-Host "âœ… è¿œç¨‹æ¡Œé¢æœåŠ¡å·²å¯åŠ¨"

      - name: Create RDP User with Flexible Password
        run: |
          Write-Host "=== åˆ›å»º RDP ç”¨æˆ· ==="
          
          # å¯†ç é€‰æ‹©é€»è¾‘
          $passwordFromSecret = "${{ secrets.RDP_PASSWORD }}"
          $useRandomFromInput = "${{ github.event.inputs.use_random_password }}"
          $useRandomFromVar = "${{ vars.USE_RANDOM_PASSWORD }}"
          
          $password = $null
          $passwordSource = "æœªçŸ¥"
          
          # ä¼˜å…ˆçº§ 1: æ‰‹åŠ¨è§¦å‘è¾“å…¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
          if ($useRandomFromInput -eq "true") {
              Write-Host "ğŸ”§ ä½¿ç”¨æ‰‹åŠ¨è§¦å‘é€‰æ‹©çš„éšæœºå¯†ç "
              $passwordSource = "æ‰‹åŠ¨è§¦å‘éšæœºå¯†ç "
          }
          # ä¼˜å…ˆçº§ 2: GitHub Secrets
          elseif (-not [string]::IsNullOrWhiteSpace($passwordFromSecret)) {
              Write-Host "ğŸ” ä½¿ç”¨ GitHub Secrets å¯†ç "
              $password = $passwordFromSecret
              $passwordSource = "GitHub Secrets"
          }
          # ä¼˜å…ˆçº§ 3: GitHub Variables éšæœºå¯†ç 
          elseif ($useRandomFromVar -eq "true" -or $useRandomFromVar -eq "1") {
              Write-Host "ğŸ² ä½¿ç”¨ Variables è®¾ç½®çš„éšæœºå¯†ç "
              $passwordSource = "Variables éšæœºå¯†ç "
          }
          # ä¼˜å…ˆçº§ 4: å›ºå®šå¯†ç 
          else {
              Write-Host "ğŸ“ ä½¿ç”¨å›ºå®šå¯†ç "
              $password = "Aa147369"
              $passwordSource = "å›ºå®šå¯†ç "
          }
          
          # å¦‚æœéœ€è¦ç”Ÿæˆéšæœºå¯†ç 
          if ($passwordSource -like "*éšæœºå¯†ç *") {
              $charSet = @{
                  Upper   = [char[]](65..90)      # A-Z
                  Lower   = [char[]](97..122)     # a-z
                  Number  = [char[]](48..57)      # 0-9
                  Special = [char[]](33,35,36,37,38,42,64,94,95) # !#$%&*@^_
              }
              $rawPassword = @()
              $rawPassword += $charSet.Upper | Get-Random -Count 3
              $rawPassword += $charSet.Lower | Get-Random -Count 3
              $rawPassword += $charSet.Number | Get-Random -Count 3
              $rawPassword += $charSet.Special | Get-Random -Count 3
              $password = -join ($rawPassword | Sort-Object { Get-Random })
          }
          
          Write-Host "å¯†ç æ¥æº: $passwordSource"
          Write-Host "å¯†ç é•¿åº¦: $($password.Length) å­—ç¬¦"
          
          # åˆ é™¤å·²å­˜åœ¨çš„ç”¨æˆ·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          $existingUser = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name $env:RDP_USERNAME
              Write-Host "âœ… å·²åˆ é™¤å·²å­˜åœ¨çš„ç”¨æˆ·"
          }
          
          # åˆ›å»ºæ–°ç”¨æˆ·
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $env:RDP_USERNAME -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME
          Write-Host "âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ: $env:RDP_USERNAME"
          
          # å­˜å‚¨åˆ°ç¯å¢ƒå˜é‡
          echo "RDP_PASSWORD_SOURCE=$passwordSource" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD_VALUE=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          Write-Host "=== å®‰è£… Tailscale ==="
          
          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
          $tsInstalled = Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -like "*Tailscale*" }
          if ($tsInstalled) {
              Write-Host "âœ… Tailscale å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…"
          } else {
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
              $installerPath = "$env:TEMP\tailscale-latest.msi"
              
              Write-Host "ä¸‹è½½ Tailscale..."
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
              
              Write-Host "å®‰è£… Tailscale..."
              Start-Process msiexec.exe -Wait -ArgumentList @(
                  "/i", "`"$installerPath`"",
                  "/quiet",
                  "/norestart",
                  "LAUNCHAPP=0"
              )
              
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              Write-Host "âœ… Tailscale å®‰è£…å®Œæˆ"
          }

      - name: Establish Tailscale Connection
        run: |
          Write-Host "=== å»ºç«‹ Tailscale è¿æ¥ ==="
          
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscaleExe)) {
              $tailscaleExe = "${env:ProgramFiles(x86)}\Tailscale\tailscale.exe"
          }
          
          if (-not (Test-Path $tailscaleExe)) {
              Write-Error "âŒ æ‰¾ä¸åˆ° Tailscale å¯æ‰§è¡Œæ–‡ä»¶"
              exit 1
          }
          
          # å¯åŠ¨ Tailscale
          Write-Host "å¯åŠ¨ Tailscale è¿æ¥..."
          & $tailscaleExe up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=perm-rdp-$env:COMPUTERNAME --accept-routes
          
          # ç­‰å¾…è·å– IP
          Write-Host "ç­‰å¾… IP åˆ†é…..."
          $tsIP = $null
          $maxRetries = 12
          $retryCount = 0
          
          while (-not $tsIP -and $retryCount -lt $maxRetries) {
              $tsIP = & $tailscaleExe ip -4
              if (-not $tsIP) {
                  $retryCount++
                  Write-Host "ç¬¬ $retryCount/$maxRetries æ¬¡å°è¯•..."
                  Start-Sleep -Seconds 10
              }
          }
          
          if (-not $tsIP) {
              Write-Error "âŒ Tailscale IP åˆ†é…å¤±è´¥"
              exit 1
          }
          
          Write-Host "âœ… Tailscale IP: $tsIP"
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          Write-Host "=== éªŒè¯ RDP å¯è®¿é—®æ€§ ==="
          Write-Host "ç›®æ ‡ IP: $env:TAILSCALE_IP"
          
          # æµ‹è¯•æœ¬åœ° RDP æœåŠ¡
          $localTest = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
          if ($localTest) {
              Write-Host "âœ… æœ¬åœ° RDP æœåŠ¡æ­£åœ¨ç›‘å¬"
          } else {
              Write-Error "âŒ æœ¬åœ° RDP æœåŠ¡æœªå¯åŠ¨"
              exit 1
          }
          
          # æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼ˆé€šè¿‡ Tailscaleï¼‰
          Write-Host "æµ‹è¯•ç½‘ç»œè¿é€šæ€§..."
          $pingResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
          if ($pingResult) {
              Write-Host "âœ… RDP ç«¯å£è¿é€šæ€§æµ‹è¯•æˆåŠŸ"
          } else {
              Write-Host "âš ï¸  ç›´æ¥ç«¯å£æµ‹è¯•å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
              # å¯èƒ½æ˜¯é˜²ç«å¢™é˜»æ­¢ï¼Œä½†æœåŠ¡å¯èƒ½ä»åœ¨è¿è¡Œ
          }
          
          Write-Host "âœ… RDP æœåŠ¡éªŒè¯å®Œæˆ"

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "ğŸ‰ PERMANENT RDP æœåŠ¡å·²å¯åŠ¨ï¼"
          Write-Host "================================================"
          Write-Host "ğŸŒ è¿æ¥åœ°å€: $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host "ğŸ”‘ å¯†ç : $env:RDP_PASSWORD_VALUE"
          Write-Host "ğŸ“ å¯†ç æ¥æº: $env:RDP_PASSWORD_SOURCE"
          Write-Host "ğŸ’» è®¡ç®—æœºå: $env:COMPUTERNAME"
          Write-Host "ğŸ•’ å¯åŠ¨æ—¶é—´: $(Get-Date)"
          Write-Host "================================================"
          Write-Host ""
          Write-Host "ğŸ“‹ ä½¿ç”¨è¯´æ˜:"
          Write-Host "   1. ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥å·¥å…·"
          Write-Host "   2. è¾“å…¥ä¸Šè¿°åœ°å€å’Œå‡­æ®"
          Write-Host "   3. äº«å—æ°¸ä¹… RDP è®¿é—®ï¼"
          Write-Host ""
          Write-Host "â¹ï¸  åœæ­¢æœåŠ¡:"
          Write-Host "   - åœ¨ GitHub Actions ç•Œé¢ç‚¹å‡» 'Cancel workflow'"
          Write-Host "   - æˆ–åœæ­¢æœåŠ¡å™¨ä¸Šçš„ GitHub Runner æœåŠ¡"
          Write-Host "================================================"

      - name: Maintain Permanent Connection
        run: |
          Write-Host "=== è¿›å…¥æ°¸ä¹…è¿è¡Œæ¨¡å¼ ==="
          Write-Host "æ­¤æ­¥éª¤å°†ä¿æŒ RDP æœåŠ¡æ— é™æœŸè¿è¡Œ"
          Write-Host "è¦åœæ­¢æœåŠ¡ï¼Œè¯·åœ¨ GitHub Actions ç•Œé¢ç‚¹å‡» 'Cancel workflow'"
          Write-Host ""
          
          # æ— é™å¾ªç¯å¼€å§‹ - è¿™æ˜¯å®ç°"æ— é™ä½¿ç”¨"çš„æ ¸å¿ƒ
          $startTime = Get-Date
          $checkCount = 0
          $lastStatusTime = Get-Date
          
          while ($true) {
              $currentTime = Get-Date
              $runningTime = $currentTime - $startTime
              $checkCount++
              
              # æ¯5åˆ†é’Ÿæ˜¾ç¤ºè¯¦ç»†çŠ¶æ€
              if (($currentTime - $lastStatusTime).TotalMinutes -ge 5) {
                  Write-Host ""
                  Write-Host "=== RDP æœåŠ¡çŠ¶æ€æ›´æ–° ==="
                  Write-Host "è¿è¡Œæ—¶é—´: $([math]::Round($runningTime.TotalHours, 1)) å°æ—¶"
                  Write-Host "æ£€æŸ¥æ¬¡æ•°: $checkCount"
                  Write-Host "æœåŠ¡å™¨æ—¶é—´: $currentTime"
                  Write-Host "è¿æ¥åœ°å€: $env:TAILSCALE_IP"
                  Write-Host "ç”¨æˆ·å: $env:RDP_USERNAME"
                  Write-Host "å¯†ç æ¥æº: $env:RDP_PASSWORD_SOURCE"
                  Write-Host "=========================="
                  Write-Host ""
                  $lastStatusTime = $currentTime
              }
              
              # ç®€å•å¿ƒè·³ï¼ˆæ¯åˆ†é’Ÿï¼‰
              if ($checkCount % 12 -eq 0) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] â™¥ RDP æœåŠ¡æ­£å¸¸è¿è¡Œ - æ€»è¿è¡Œ: $([math]::Round($runningTime.TotalHours, 1))h"
              }
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆæ¯10æ¬¡å¾ªç¯ï¼‰
              if ($checkCount % 10 -eq 0) {
                  $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  $tailscaleProcess = Get-Process -Name tailscale -ErrorAction SilentlyContinue
                  
                  if ($rdpService.Status -ne "Running") {
                      Write-Host "âš ï¸  RDP æœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯..."
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  if (-not $tailscaleProcess) {
                      Write-Host "âš ï¸  Tailscale æœªè¿è¡Œï¼Œå°è¯•é‡å¯..."
                      & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset
                  }
              }
              
              # ç­‰å¾… 5 ç§’åç»§ç»­å¾ªç¯
              Start-Sleep -Seconds 5
          }
